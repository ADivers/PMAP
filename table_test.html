<!DOCTYPE html>
<html>
<head>
	<title>PMAP</title>
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <!-- Compiled and minified CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.1/css/materialize.min.css">
	<link rel="stylesheet" type="text/css" href="assets/css/style.css">
	<link rel="stylesheet" href="styles/main.css"/>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.1/js/materialize.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.SPServices/2014.02/jquery.SPServices-2014.02.js"></script>
	<script src="scripts/app.js"></script>
	<!--Let browser know website is optimized for mobile-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

</head>
<body>

	<div class="container">
		<div class="row">
			<div class="col s12  m6 input-field">
				<i class="material-icons prefix">search</i>
				<input type="search" id="search" class="input-field">
			</div>
			<div id='main-content' class="col s12">
				<table id="employees">
					<thead>
						<tr>
							<!-- <th></th> -->
							<th>Employee Name</th>
							<th>Employee ID</th>
							<th>Admin ID</th>
							<th>Director ID</th>
							<th>Manager ID</th>
							<th>Team Lead ID</th>
						</tr>
					</thead>
					<tbody></tbody>
				</table>
			</div>
		</div>
		<div class="divider"></div>
	</div>

	<script src="./scripts/app.js"></script>
	<script>

	window.onload = function(){

		//Define variables
		var req,
				res,
				recordID,
				tablerow,
				tabledef,
				table = document.getElementById(  'employees' ),
				tablebody = document.querySelector(  '#employees>tbody'  ),
				mainContent,
				edit,
				editForm,
				input,
				label,
				$tableHeaders,
				$headerText,
				inputFieldnames = {
					'Employee Name'	:	'employee_name',
					'Employee ID'		:	'employee_ID',
					'Admin ID'			:	'admin_ID',
					'Director ID'		:	'director_ID',
					'Manager ID'		:	'manager_ID',
					'Team Lead ID'	:	'teamlead_ID'
				},
			 getFieldnames = function(){
					var fieldnames = '<ViewFields>';
					for(  var fieldname in inputFieldnames  ){
						fieldnames +='<FieldRef Name="' + inputFieldnames[  fieldname  ];
						fieldnames += '"/>';
					}
					fieldnames += '</ViewFields>';
					return fieldnames;
				},
				fieldnames = getFieldnames();
				console.log(  "FIELDNAMES: " + fieldnames  );

				//webURL = APP.getURL();
				webURL = "https://teams.deloitte.com/sites/FDAJDD/Sandbox/";

				$().SPServices(
					{
						operation: "GetListItems",
						viewName: '',
						webURL: "https://teams.deloitte.com/sites/FDAJDD/Sandbox/",
						listName: "Employee_List01",
						CAMLViewFields: fieldnames,
						CAMLRowLimit: 5,
						CAMLQueryOptions: '<QueryOptions><IncludeMandatoryColumns>TRUE</IncludeMandatoryColumns></QueryOptions>',
						CAMLQuery: '<Query><OrderBy><FieldRef Name="employee_name" Ascending="TRUE"></FieldRef></OrderBy></Query>',
						completefunc: function(  xData, Status  ){
							console.log( "STATUS: " + Status  );
							var res = $(  xData.responseXML  ).SPFilterNode( 'z:row'  ).SPXmlToJson(
								{
									mapping : {
										ows_employee_name			:	{  mappedName: 'employee_name', objectType: 'Text'  },
										ows_employee_ID				:	{  mappedName: 'employee_ID', objectType: 'Text'  },
										ows_admin_ID					:	{  mappedName: 'admin_ID', objectType: 'Text'  },
										ows_director_ID				:	{  mappedName: 'director_ID', objectType: 'Text'  },
										ows_manager_ID				:	{  mappedName: 'manager_ID', objectType: 'Text'  },
										ows_teamlead_ID				:	{  mappedName: 'teamlead_ID', objectType: 'Text'  }
									},
									includeAllAttrs: false,
									removeOws: true,
									sparse: false
								}
							),
							idArray = [];

							console.log(  "RESPONSE: " + res  );
							console.log(  xData.responseText  );
							$(  xData.responseXML  ).SPFilterNode(  'z:row'  ).each(  function(){
								console.log(  $(  this  ).attr(  'ows_ID'  )  );
								idArray.push(  $(  this  ).attr(  'ows_ID'  )  );
							});
							//console.log( $(  xData.responseXML  ).find(  "[nodeName='rs:data']" )  );	-->OK

							/***********************BEGIN DOM CONSTRUCTION******************************/
							for(  var i = 0; i < res.length; i+= 1  ){
								//Begin DOM element setup
								tablerow = document.createElement(  'tr'  );
								//

								//'Edit' buttons for returned rows
								edit = document.createElement(  'button'  );
								edit.innerHTML = '<i class="material-icons">edit</i>';
								edit.className = 'btn-floating tooltipped blue darken-4  modal-trigger';
								edit.style.marginRight = '.5px';
								edit.style.float = "right";
								edit.setAttribute(  'data-position', 'right');
								edit.setAttribute(  'data-delay', '50'  );
								edit.setAttribute(  'data-tooltip', 'Edit'  );
								edit.setAttribute(  'data-index', i  );
								edit.setAttribute(  'data-record-id', idArray[  i  ]  );

								//Add event listener to create and draw modal on 'edit' click
								edit.addEventListener(  'click',  function(  e  ){

									//Initialize wrapper div for main page content (Table and Form)
									mainContent = document.querySelector(  '#main-content' );
									//Set position for main page content
									//mainContent.style.position = 'absolute';
									//mainContent.style.zIndex = 100;

									//Remove modal if it exists
									if(  document.getElementById(  'modal_01'  )  ){
										mainContent.removeChild(  document.getElementById(  'modal_01'  )  );
									}

									//Define and initialize modal variables

									var modal = document.createElement(  'div'  );
											modalContent = document.createElement(  'div'  ),
											modalFooter = document.createElement(  'div'  ),
											modalEdit = document.createElement(  'button'  ),
											modalClose = document.createElement(  'button'  ),
											editForm = document.createElement(  'form'  ),
											$tableHeaders = $(  '#employees>thead>tr'  ).children(  'th'  );
											$headerText =	$tableHeaders.contents();
											//Set attributes of modal
											modal.setAttribute(  'id', 'modal_01');
											modal.style.display = 'block';
											modal.setAttribute(  'position', 'relative'  );
											modalContent.setAttribute(  'id', 'modal-content' ) ;
											//**POSITIONING VARS FOR MODAL NOT YET WORKING**//
											// modal.style.zIndex = 200;
											// modal.style.left = 100 + "px";
											// modal.style.top = 100 + "px";
											/***********************************************/
											modalEdit.innerText = 'SAVE';
											modalClose.innerText = 'CANCEL';

											//Set attributes of edit form
											editForm.setAttribute(  'id', 'edit-form'  );
											//Get ID of record to be updated and attach to form attribute
											editForm.setAttribute(  'data-record-id', e.target.getAttribute(  'data-record-id'  )  );
											editForm.setAttribute(  'method', 'POST'  );

											//Set attributes of edit/cancel buttons
											modalEdit.className ='btn waves-effect waves-light edit';
											modalEdit.setAttribute(  'type', 'submit'  );
											modalEdit.setAttribute(  'data-record-id',  idArray[  i  ]  );
											modalEdit.innerText = "EDIT";
											modalClose.className ='btn waves-effect waves-light';
											modalClose.innerText = "CANCEL";

											//Create form inputs
											for(  var indx = 0; indx < $headerText.length; indx++ ){
												var currentIdx = e.target.getAttribute(  'data-index' );

												//Create input fields and labels
												input = document.createElement(  'input'  );
												label = document.createElement(  'label' );

												//Set input field attributes
												input.setAttribute(  'type', 'text'  );
												input.setAttribute(  'id', $headerText[  indx  ][  'data'  ]  );
												for(  var prop in inputFieldnames  ){
													/**
													*TODO: 07-27-2017 19:04 EST
													*REFACTOR to save present stored values as DEFAULTS
													when user saves record but DOES NOT update all form
													fields.  CURRENT STATE: Application saves blank (null)
													values if user does not update form field.
													*/
													if(  input.id === prop  ){
														input.setAttribute(  'name', inputFieldnames[  prop  ]  );
													}
												}
												if(  input.getAttribute(  'id'  ) === "Employee Name"  ){
													input.setAttribute(  'placeholder', res[  currentIdx  ][  'employee_name'  ]  );
												}
												if(  input.getAttribute(  'id'  ) === 'Employee ID'  ){
													input.setAttribute(  'value', res[  currentIdx  ][  'employee_ID'  ]  );
													input.setAttribute(  'innerText', res[  currentIdx  ][  'employee_ID'  ]  );
													input.setAttribute(  'readonly', 'readonly'  );
												}
												label.setAttribute(  'for', $headerText[  indx  ][  'data'  ]  );
												label.innerText = $headerText[  indx  ][  'data'  ];
												editForm.appendChild(  input  );
												editForm.appendChild(  label  );

											}

									modalContent.appendChild(  editForm  );

									//Append children to modal elements
									modalFooter.appendChild(  modalEdit  );
									modalFooter.appendChild(  modalClose  );
									modal.appendChild(  modalContent  );
									modal.appendChild(  modalFooter  );

									//Append modal to DOM
									mainContent.appendChild(  modal  );

									//Attach event listener to modalClose
									//(IE does not support remove() method; will throw ERROR)
									modalClose.addEventListener(  'click', function(  f  ){
										//f.preventDefault();
										mainContent.removeChild(  modal  );
									}, false  );

									//Attach event listener to modalEdit
									modalEdit.addEventListener(  'click', function(  g  ){
										console.log(  g.target  );
										g.preventDefault();
										//console.log(  $(  'input[name="employee_name"]'  ).val()  );	-->OK
										var $formInputs = $(  'form>input'  ).serializeArray(),
												valuePairs = [],
												pair;

												console.log(  $formInputs  );
												// recordID = $(  )
												for( var x = 0; x < $formInputs.length; x+= 1){
													pair = [];
													pair.push(  $formInputs[  x  ][  'name'  ]  );
													pair.push(  $formInputs[  x  ][  'value']  );
													valuePairs.push(  pair  );
												}
												//console.log(  valuePairs  );

										$().SPServices(
											{
												webURL			:		webURL,
												operation		:		'UpdateListItems',
												async				:		false,
												listName		:		'Employee_List01',
												batchCmd		:		'Update',
												valuepairs	:		valuePairs,
												ID					:		editForm.getAttribute(  'data-record-id'  ),
												completefunc:		function(  xData, Status  ){
													console.log(  "Update Status: " + Status  );
												}
											}
										);
										//CREATES A NEW RECORD, YOU WANT TO UPDATE A RECORD
												// $().SPServices(
												// 	{
												// 		operation         :       "UpdateListItems",
												// 		async             :       false,
												// 		batchCmd          :       "New",
												// 		listName          :       "Employee_List01",
												// 		webURL						:				webURL,
												// 		ID                :       $id,
												// 		valuepairs        :       valuePairs,
												// 		completefunc      :       function(  xData, Status  ){
												// 			console.log(  "'Create New List Items' Operation status: "  + Status  );
												// 			if(  Status === 'error'  ){
												// 				console.log(  xData.statusText  );
												// 			}
												// 		}
												// 	}
												// )
									}, false  );

									//	IE doesn't play nice with modals
								}, false  );	//END MODALEDIT ADD EVENT LISTENER


								$(  '.tooltipped'  ).tooltip(  {  delay : 50  }  );

								for(  var j in res[  i  ]  ){

									if(  res[  i  ].hasOwnProperty(  j  )  ){
										tabledef = document.createElement(  'td'  );
										tabledef.innerText = res[  i  ][  j  ];
										tabledef.innerText = res[  i  ][  j  ];
										tabledef.appendChild(  edit  );

										// console.log(  tabledef  );
										tablerow.appendChild(  tabledef  );
									}
								}
								tablebody.appendChild(  tablerow  );
								table.className = 'bordered highlight';

								// console.log(  json_data  );
								// console.log(  tablebody  );
								var $rows = $('#employees tbody tr');
								$('#search').keyup(function() {

								    var val = '^(?=.*\\b' + $.trim($(this).val()).split(/\s+/).join('\\b)(?=.*\\b') + ').*$',
								        reg = RegExp(val, 'i'),
								        text;

								    $rows.show().filter(function() {
								        text = $(this).text().replace(/\s+/g, ' ');
								        return !reg.test(text);
								    }).hide();
								});

							}
							/***********************END DOM CONSTRUCTION*******************************/

						}	//END completfunc
					});	//END $().SPServices()
			};	//END window.onload

	</script>
</body>
</html>
